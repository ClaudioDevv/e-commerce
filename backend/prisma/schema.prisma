// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

generator dbml {
  provider = "prisma-dbml-generator"
  output = "./dbml"
}

datasource db {
  provider = "postgresql"
}

// ==================== USUARIOS ====================

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  password  String
  name      String
  surname   String
  phone     String    @unique
  role      UserRole  @default(CUSTOMER)
  active    Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  addresses Address[]
  cartItems CartItem[]
  orders    Order[]
  refreshtokens  RefreshToken[]

  @@index([email])
  @@index([phone])
}

enum UserRole {
  CUSTOMER
  ADMIN
  STAFF
}

model RefreshToken {
  id          String @id @default(uuid())
  token       String @unique
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  createdAt   DateTime  @default(now())
  expiresAt   DateTime
  deviceInfo  String

  @@index([token])
  @@index([userId])
}

model Address {
  id           String   @id @default(uuid())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  label        String?
  street       String
  city         String
  postalCode   String
  province     String?
  instructions String?
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())

  orders Order[]

  @@index([userId])
}

// ==================== PRODUCTOS ====================

model Product {
  id          String           @id @default(uuid())
  name        String
  description String?
  category    Category
  basePrice   Decimal          @db.Decimal(10,2)  
  imageUrl    String?
  active      Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  variants    ProductVariant[]
  pizzaConfig PizzaConfig?     // Solo pizzas tienen configuración
  cartItems   CartItem[]
  orderItems  OrderItem[]

  @@index([category])
  @@index([active])
}

enum Category {
  PIZZA
  BEBIDA
  ENTRANTE
  POSTRE
}

model ProductVariant {
  id         String   @id @default(uuid())
  name       String   // "Mediana", "Familiar", "1L", "33cl"
  priceDelta Decimal  @db.Decimal(10,2)
  active     Boolean  @default(true)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId  String

  cartItems  CartItem[]
  orderItems OrderItem[]

  @@index([productId])
}

// ==================== PIZZAS E INGREDIENTES ====================

model PizzaConfig {
  id                 String                @id @default(uuid())
  product            Product               @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId          String                @unique
  allowCustomization Boolean               @default(true)
  baseIngredients    PizzaBaseIngredient[]  // Ingredientes por defecto
}

model Ingredient {
  id         Int                   @id @default(autoincrement())
  name       String                @unique
  extraPrice Decimal               @db.Decimal(10,2)
  available  Boolean               @default(true)
  category   IngredientCategory?
  imageUrl   String?
  createdAt  DateTime              @default(now())

  pizzaBase     PizzaBaseIngredient[]
  cartCustom    CartItemIngredient[]
  orderCustom   OrderItemIngredient[]

  @@index([available])
}

enum IngredientCategory {
  QUESO
  CARNE
  VEGETAL
  SALSA
  EXTRA
}

// Ingredientes que vienen por defecto en cada pizza
model PizzaBaseIngredient {
  pizzaConfigId String
  pizzaConfig   PizzaConfig @relation(fields: [pizzaConfigId], references: [id], onDelete: Cascade)
  ingredientId  Int
  ingredient    Ingredient  @relation(fields: [ingredientId], references: [id])

  @@id([pizzaConfigId, ingredientId])
}

// ==================== CARRITO ====================

model CartItem {
  id         String     @id @default(uuid())
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String
  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId  String
  variant    ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  variantId  String?
  quantity   Int        @default(1)
  notes      String?    // "Sin cebolla", "Bien hecha", etc.
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  customIngredients CartItemIngredient[]  // Personalizaciones de pizza

  @@index([userId])
  @@index([productId])
}

// Ingredientes personalizados en el carrito (solo para pizzas)
model CartItemIngredient {
  cartItemId   String
  cartItem     CartItem   @relation(fields: [cartItemId], references: [id], onDelete: Cascade)
  ingredientId Int
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])
  action       IngredientAction  // ADD = añadir extra, REMOVE = quitar base

  @@id([cartItemId, ingredientId, action])
}

enum IngredientAction {
  ADD    // Añadir ingrediente extra
  REMOVE // Quitar ingrediente base
}

// ==================== PEDIDOS ====================

model Order {
  id       String  @id @default(uuid())
  user     User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId   String?
  isGuest  Boolean @default(false)

  // Datos de contacto (obligatorios siempre que sea guest) de un usuario ya tendremos esos datos
  customerName  String
  customerPhone String

  // Tipo de entrega
  deliveryType DeliveryType @default(DELIVERY)

  // Dirección (solo si deliveryType = DELIVERY)
  address   Address? @relation(fields: [addressId], references: [id], onDelete: SetNull)
  addressId String?

  // Snapshot de dirección de entrega (para historial)
  deliveryStreet       String?
  deliveryCity         String?
  deliveryPostalCode   String?
  deliveryInstructions String?

  // Hora programada (opcional)
  scheduledFor  DateTime? // Hora solicitada por el cliente
  estimatedTime DateTime? // Hora estimada por la pizzería

  // Precios
  subtotal    Decimal   @db.Decimal(10,2)
  deliveryFee Decimal   @db.Decimal(10,2)
  total       Decimal   @db.Decimal(10,2)

  // Estado
  status    OrderStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items   OrderItem[]
  payment Payment?

  @@index([userId])
  @@index([status])
  @@index([deliveryType])
  @@index([createdAt])
}

enum DeliveryType {
  DELIVERY // A domicilio
  PICKUP   // Recoger en tienda
}

model OrderItem {
  id        String  @id @default(uuid())
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId   String
  product   Product @relation(fields: [productId], references: [id])
  productId String
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  variantId String?

  // Snapshots para historial (por si cambian precios/nombres)
  nameSnapshot    String
  variantSnapshot String?
  notesSnapshot   String?
  unitPrice       Decimal   @db.Decimal(10,2)
  quantity        Int
  subtotal        Decimal   @db.Decimal(10,2)

  customIngredients OrderItemIngredient[]  // Snapshot de personalizaciones

  @@index([orderId])
}

// Snapshot de ingredientes personalizados en el pedido
model OrderItemIngredient {
  orderItemId   String
  orderItem     OrderItem  @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  ingredientId  Int
  ingredient    Ingredient @relation(fields: [ingredientId], references: [id])
  action        IngredientAction
  priceSnapshot Decimal   @db.Decimal(10,2)

  @@id([orderItemId, ingredientId, action])
}

enum OrderStatus {
  PENDING    // Recibido, esperando pago/confirmación
  PAID       // Pagado
  CONFIRMED  // Confirmado por la pizzería
  PREPARING  // En cocina
  READY      // Listo para recoger/enviar
  ON_THE_WAY // En camino (solo DELIVERY)
  DELIVERED  // Entregado/Recogido
  CANCELLED  // Cancelado
}

// ==================== PAGOS ====================

model Payment {
  id                String          @id @default(uuid())
  order             Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId           String          @unique
  provider          PaymentProvider @default(STRIPE)
  providerPaymentId String?         // ID del paymentIntent de Stripe
  amount            Float
  currency          String          @default("EUR")
  status            PaymentStatus   @default(PENDING)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([providerPaymentId])
  @@index([status])
}

model Settings {
  id             String    @id @default(uuid())

  // Horarios (usamos texto porque TIME es incómodo en JS/TS)
  openTime       String    // Ej: "12:00"
  closeTime      String    // Ej: "23:30"

  // Opcional: descanso/siesta
  breakStart     String?   // Ej: "16:00"
  breakEnd       String?   // Ej: "19:00"

  // Configuración pedidos
  deliveryFee    Decimal   @db.Decimal(10,2) @default(0.00)
  minOrderAmount Decimal   @db.Decimal(10,2) @default(0.00)
  avgPrepMinutes Int       @default(30)
  autoAcceptOrders Boolean @default(true)

  // Control de estado del negocio
  temporarilyClosed Boolean @default(false) // útil para cierres rápidos
  statusMessage      String?               // Ej: "Cerrado por mantenimiento"

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

enum PaymentProvider {
  STRIPE            // Pago online con tarjeta
  CASH_ON_DELIVERY  // Efectivo al recibir/recoger
  CARD_ON_DELIVERY  // Datáfono al recibir/recoger
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}
